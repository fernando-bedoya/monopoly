<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking Global - Monopoly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/views/css/ranking.css">
</head>
<body>
    <div class="ranking-container">
        <!-- Header del Ranking -->
        <div class="ranking-header">
            <h1>üèÜ Ranking Global de Monopoly</h1>
            <p class="mb-0">Los mejores jugadores de todos los tiempos</p>
        </div>

        <!-- Bot√≥n de regreso -->
        <div class="back-btn">
            <button class="btn btn-outline-primary" onclick="window.history.back()">
                ‚Üê Regresar
            </button>
        </div>

        <!-- Estad√≠sticas generales -->
        <div class="stats-container" id="statsContainer" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalPlayers">0</div>
                <div class="stat-label">Jugadores Totales</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="highestScore">$0</div>
                <div class="stat-label">Puntaje M√°s Alto</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCountries">0</div>
                <div class="stat-label">Pa√≠ses Representados</div>
            </div>
        </div>

        <!-- Contenedor de loading -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando ranking...</span>
            </div>
            <p class="mt-3">Cargando ranking global...</p>
        </div>

        <!-- Contenedor de error -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <h5>‚ùå Error al cargar el ranking</h5>
            <p id="errorDetails">No se pudo conectar con el servidor.</p>
            <button class="btn btn-primary" onclick="cargarRanking()">Intentar de nuevo</button>
        </div>

        <!-- Tabla de ranking -->
        <div class="ranking-table" id="rankingTable" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead style="background: #f8f9fa;">
                        <tr>
                            <th width="80">Pos</th>
                            <th>Jugador</th>
                            <th width="150" class="text-center">Pa√≠s</th>
                            <th width="150" class="text-end">Puntaje</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody">
                        <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mensaje de ranking vac√≠o -->
        <div class="text-center" id="emptyMessage" style="display: none; padding: 50px;">
            <h4>üìä No hay datos en el ranking</h4>
            <p>S√© el primero en jugar y aparecer en el ranking global!</p>
            <button class="btn btn-primary" onclick="window.location.href='../index.html'">
                Jugar Ahora
            </button>
        </div>
    </div>

    <!-- Bot√≥n flotante de refrescar -->
    <button class="btn btn-primary rounded-circle refresh-btn" onclick="cargarRanking()" title="Actualizar ranking">
        üîÑ
    </button>

    <script>
        // Variables globales
        let rankingData = [];

        /**
         * Carga el ranking desde el API
         */
        async function cargarRanking() {
            mostrarLoading();
            
            try {
                console.log('üîÑ Cargando ranking desde el API...');
                
                const response = await fetch('http://127.0.0.1:5000/ranking', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('‚úÖ Ranking cargado exitosamente:', data);
                
                rankingData = Array.isArray(data) ? data : [];
                mostrarRanking(rankingData);
                
            } catch (error) {
                console.error('‚ùå Error al cargar ranking:', error);
                mostrarError(error.message);
            }
        }

        /**
         * Muestra el estado de loading
         */
        function mostrarLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('rankingTable').style.display = 'none';
            document.getElementById('emptyMessage').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
        }

        /**
         * Muestra mensaje de error
         */
        function mostrarError(mensaje) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('rankingTable').style.display = 'none';
            document.getElementById('emptyMessage').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            
            document.getElementById('errorDetails').textContent = mensaje;
        }

        /**
         * Muestra el ranking en la tabla
         */
        function mostrarRanking(data) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            if (!data || data.length === 0) {
                document.getElementById('emptyMessage').style.display = 'block';
                document.getElementById('rankingTable').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
                return;
            }

            // Mostrar estad√≠sticas
            mostrarEstadisticas(data);
            
            // Mostrar tabla
            document.getElementById('rankingTable').style.display = 'block';
            document.getElementById('emptyMessage').style.display = 'none';
            
            const tbody = document.getElementById('rankingTableBody');
            tbody.innerHTML = '';

            data.forEach((jugador, index) => {
                const position = index + 1;
                const row = crearFilaRanking(jugador, position);
                tbody.appendChild(row);
            });
        }

        /**
         * Crea una fila de la tabla de ranking
         */
        function crearFilaRanking(jugador, position) {
            const row = document.createElement('tr');
            row.className = 'ranking-row';

            // Columna de posici√≥n
            const positionCell = document.createElement('td');
            positionCell.className = `ranking-position position-${position <= 3 ? position : ''}`;
            
            let emoji = '';
            if (position === 1) emoji = 'ü•á';
            else if (position === 2) emoji = 'ü•à';
            else if (position === 3) emoji = 'ü•â';
            else emoji = position;
            
            positionCell.textContent = emoji;

            // Columna de jugador
            const playerCell = document.createElement('td');
            playerCell.innerHTML = `
                <div class="player-info">
                    <strong>${jugador.nick_name || 'Jugador An√≥nimo'}</strong>
                </div>
            `;

            // Columna de pa√≠s con bandera
            const countryCell = document.createElement('td');
            countryCell.className = 'text-center';
            const countryCode = jugador.country_code || 'co';
            countryCell.innerHTML = `
                <div class="player-info justify-content-center">
                    <img src="https://flagsapi.com/${countryCode.toUpperCase()}/flat/32.png" 
                         alt="${countryCode}" class="flag-img" 
                         onerror="this.src='https://flagsapi.com/CO/flat/32.png'">
                    <span>${countryCode.toUpperCase()}</span>
                </div>
            `;

            // Columna de puntaje
            const scoreCell = document.createElement('td');
            scoreCell.className = 'text-end';
            scoreCell.innerHTML = `<span class="score-badge">$${jugador.score?.toLocaleString() || '0'}</span>`;

            row.appendChild(positionCell);
            row.appendChild(playerCell);
            row.appendChild(countryCell);
            row.appendChild(scoreCell);

            return row;
        }

        /**
         * Muestra estad√≠sticas generales
         */
        function mostrarEstadisticas(data) {
            const totalPlayers = data.length;
            const highestScore = Math.max(...data.map(j => j.score || 0));
            const countries = [...new Set(data.map(j => j.country_code || 'co'))];
            const totalCountries = countries.length;

            document.getElementById('totalPlayers').textContent = totalPlayers;
            document.getElementById('highestScore').textContent = '$' + highestScore.toLocaleString();
            document.getElementById('totalCountries').textContent = totalCountries;
            document.getElementById('statsContainer').style.display = 'grid';
        }

        /**
         * Funci√≥n para refrescar el ranking cada 30 segundos
         */
        function iniciarRefrescoAutomatico() {
            setInterval(() => {
                if (document.visibilityState === 'visible') {
                    console.log('üîÑ Refrescando ranking autom√°ticamente...');
                    cargarRanking();
                }
            }, 30000); // 30 segundos
        }

        // Inicializar cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéÆ P√°gina de ranking cargada');
            cargarRanking();
            iniciarRefrescoAutomatico();
        });

        // Manejar tecla F5 o Ctrl+R para refrescar
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                cargarRanking();
            }
        });
    </script>
</body>
</html>